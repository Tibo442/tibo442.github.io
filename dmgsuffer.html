<!doctype html>
<html>
    <head>
        <title>Flat is Justice! - dmg suffer</title>
        <meta name="theme-color" content="#082E6B"/>
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:title" content="Flat is Justice - Damage suffering">
        <meta name="twitter:description" content="Calculate suffering of damage based on armor/hp/maxhp">
        <meta name="twitter:image" content="http://flatisjustice.moe/pics/dmgsuffer.png">
        <style type="text/css">
            input {
                width:75px;
            }
        </style>
    </head>
    <body>
        Armor: <input type="number" id="armor" min="0" max="9999" onchange="update();" onclick="update();" value=52><br>
        MaxHP: <input type="number" id="maxhp" min="0" max="9999" onchange="update();" onclick="update();" value=37><br>
        CurrHP: <input type="number" id="currhp" min="0" max="9999" onchange="update();" onclick="update();" value=37><br>
        <br>
        Min attack: <input type="number" id="atkmin" min="0" max="9999" onchange="update();" onclick="update();" value=40><br>
        Max attack: <input type="number" id="atkmax" min="0" max="9999" onchange="update();" onclick="update();" value=140><br>
        <br>
        <canvas id="graph" width="830" height="425" style="border:1px solid black;"></canvas><br>
        <i>Based on <a href="http://kancolle-calc.net/suffering.html">KC-calc</a>, with fixed max armor roll (0.7*armor+0.6*(armor - 1) isn't included there)</i>
        <script type="text/javascript">
            var prevarmor, prevmaxhp, prevcurrhp, prevatkmin, prevatkmax;
            function update() {
                var armor = parseFloat(document.getElementById('armor').value);
                var maxhp = parseFloat(document.getElementById('maxhp').value);
                var currhp = parseFloat(document.getElementById('currhp').value);
                var atkmin = parseFloat(document.getElementById('atkmin').value);
                var atkmax = parseFloat(document.getElementById('atkmax').value) + 1;

                if(prevarmor === armor && prevmaxhp === maxhp && prevcurrhp === currhp
                    && prevatkmin === atkmin && prevatkmax == atkmax)
                    return;

                if(prevmaxhp != maxhp || currhp > maxhp) {
                    currhp += maxhp - (prevmaxhp || maxhp);
                    if(currhp > maxhp) currhp = maxhp;
                    document.getElementById('currhp').value = currhp;
                    document.getElementById('currhp').max = maxhp;
                }
                prevarmor = armor;
                prevmaxhp = maxhp;
                prevcurrhp = currhp;
                prevatkmin = atkmin;
                prevatkmax = atkmax;

                var canvas = document.getElementById("graph");
                canvas.width = canvas.width;
                var width = canvas.width - 30;
                var height = canvas.height - 25;
                var context = canvas.getContext("2d");

                // var status = [];
                for(let atk = atkmin; atk < atkmax; atk++) {
                    let dmgsDealth = {};
                    for(let arm = 0; arm < armor; arm++) {
                        let armorRoll = 0.7 * armor + arm * 0.6;
                        let dmg = Math.floor(atk - armorRoll);

                        if(dmg >= currhp && currhp > 0.25 * maxhp) { // Overkill protection
                            let possibledmg = [];
                            for(let hpRoll = 0; hpRoll < currhp; hpRoll++)
                                possibledmg.push(Math.floor(0.5 * currhp + 0.3 * hpRoll));
                            for(let posdmg of possibledmg)
                                dmgsDealth[posdmg] = (dmgsDealth[posdmg] || 0) + (1.0 / possibledmg.length);
                        } else {
                            if (dmg < 0)
                                dmg = 0;
                            dmgsDealth[dmg] = (dmgsDealth[dmg] || 0) + 1.0;
                        }
                    }
                    let sum = 0;
                    for(let posdmg in dmgsDealth)
                        sum += dmgsDealth[posdmg];
                    let stages = {
                        "taiha" : 0,
                        "chuuha" : 0,
                        "shouha" : 0,
                        "ok" : 0
                    };
                    for(let posdmg in dmgsDealth) {
                        let ch = dmgsDealth[posdmg], afterhp = currhp - posdmg;
                        if(afterhp <= 0);
                        else if(afterhp <= .25 * maxhp)
                            stages.taiha += ch/sum;
                        else if(afterhp <= .50 * maxhp)
                            stages.chuuha += ch/sum;
                        else if(afterhp <= .75 * maxhp)
                            stages.shouha += ch/sum;
                        else
                            stages.ok += ch/sum;
                    }
                    // status[atk] = stages;
                    let prev = 0;
                    context.fillStyle = "#2fd30a";
                    context.fillRect(width / (atkmax - atkmin) * (atk - atkmin), prev, width / (atkmax - atkmin), stages.ok * height);
                    prev += stages.ok * height;
                    context.fillStyle = "#d1d100";
                    context.fillRect(width / (atkmax - atkmin) * (atk - atkmin), prev, width / (atkmax - atkmin), stages.shouha * height);
                    prev += stages.shouha * height;
                    context.fillStyle = "#e5a416";
                    context.fillRect(width / (atkmax - atkmin) * (atk - atkmin), prev, width / (atkmax - atkmin), stages.chuuha * height);
                    prev += stages.chuuha * height;
                    context.fillStyle = "#e51616";
                    context.fillRect(width / (atkmax - atkmin) * (atk - atkmin), prev, width / (atkmax - atkmin), stages.taiha * height);
                    context.fillStyle = "#666";
                    if(atk % 5 == 0) {
                        context.fillStyle = "#000";
                        context.save();
                        context.translate(width / (atkmax - atkmin) * (atk - atkmin) + (width / (atkmax - atkmin)) / 2, height + 14);
                        context.rotate(-Math.PI/2);
                        context.textAlign = "center";
                        context.fillText(atk, 0, 3);
                        context.restore();
                    }
                    context.fillRect(width / (atkmax - atkmin) * (atk - atkmin), 0, 1, height);
                }
                context.fillStyle = "#000";
                context.fillRect(width, 0, 1, height+1);
                for(let percentage of [1, .75, .5, .25, 0]) {
                    context.fillRect(0, percentage * height, width, 1);
                    context.fillText(percentage * 100 + "%", width + 3, (1-percentage) * height);
                }

                //console.debug(status);
            }
            update();
        </script>
    </body>
</html>