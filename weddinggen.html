<!doctype html>
<html>
    <head>
        <script src="https://cdn.rawgit.com/konvajs/konva/2.0.2/konva.min.js"></script>
        <title>Flat is Justice! - wedding screen generator</title>
        <meta name="theme-color" content="#082E6B"/>
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Flat is Justice - wedding screen generator">
        <meta name="twitter:description" content="Make HD wedding screens">
        <meta name="twitter:image" content="http://flatisjustice.moe/pics/wedgen.png">
        <style type="text/css">
            input[type="number"] {
                width:75px;
            }
            canvas {
                margin: 5px;
            }
        </style>
    </head>
    <body>
        <a href="."><b>Flat is Justice - Home</b></a><br>
        Romanization for ship names: <input type="checkbox" id="romanized" onchange="makeSelect();" onclick="makeSelect();"><br>
        Ship: <select id="ships" autofocus name="Ship" disabled></select><select id="cgs" autofocus name="CG" disabled></select><br>
        <br>
        Original img: <input type="checkbox" id="original" onchange="update();" onclick="update();"><br>

        <b>Generated img:</b><br>
        <canvas id="graph" width="800" height="480" style="border:1px solid black;"></canvas><br>

        <b>Animated:</b><br>
        <div id="ani" style="border:1px solid black;width:800px;height:480px;margin:5px"></div><br>

        <script type="text/javascript">
            var canvas = document.getElementById("graph");
            var parser = new DOMParser();
            var data = {};
            var bubbles = [], activeBubbles = [], currentcg = {};

            function update() {
                var original = !!document.getElementById('original').checked;
                var context = canvas.getContext("2d");

                let e = document.getElementById("cgs");
                let cg = JSON.parse(e.options[e.selectedIndex].value);
                console.log(cg);
                if(cg.weda[0] == 0 && cg.weda[1] == 0 && cg.wedb[0] == 0 && cg.wedb[1] == 0)
                    alert("Missing correct api_start2 data to display this seasonal correctly");
                currentcg = cg;

                var roomImg = new Image();
                roomImg.onload = function() {
                    if(currentcg !== cg) return;
                    canvas.height = roomImg.height;
                    canvas.width = roomImg.width;
                    context.drawImage(roomImg, 0, 0);

                    var bg = new Konva.Image({
                      x: 0,
                      y: 0,
                      image: roomImg,
                    });

                    var cgimg = new Image();
                    cgimg.onload = function() {
                        if(currentcg !== cg) return;
                        let scale = 1.7475;
                        let cgscale = original ? 1.7475 : 1;
                        let x =  400 - (cg.weda[0] + cg.wedb[0] / 2) * scale, y = 10 - cg.weda[1] * scale
                            w = cgimg.width * cgscale, h = cgimg.height * cgscale;
                        context.drawImage(cgimg, x, y, w, h);

                        var shipcg = new Konva.Image({
                          x: x,
                          y: y,
                          image: cgimg,
                          width: w,
                          height: h
                        });

                        var ringimg = new Image();
                        ringimg.onload = function() {
                            if(currentcg !== cg) return;
                            context.drawImage(ringimg, 320, 270);

                            var ring = new Konva.Image({
                              x: 320,
                              y: 270,
                              image: ringimg
                            });

                            layer.clear();
                            layer.add(bg);
                            layer.add(shipcg);
                            layer.add(ring);
                            stage.clear();
                            stage.add(layer);
                            stage.add(bubbleLayer);
                        }
                        ringimg.src = "pics/ring.png";
                    }
                    cgimg.src = `${original ? "cgs" : "hd_cgs"}/${cg.url}.png`;
                }
                roomImg.src = "pics/room.png";
            }
            function get(url, name) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
                        if (xmlhttp.status == 200) {
                            data[name] = xmlhttp.responseText;
                            if(data.cgs && data.ship_affix && data.ships) {
                                data.cgs = JSON.parse(data.cgs);
                                data.ships = JSON.parse(data.ships);
                                data.ship_affix = JSON.parse(data.ship_affix);

                                makeSelect();
                            }
                       }
                    }
                };
                xmlhttp.open("GET", url, true);
                xmlhttp.send();
            }

            function makeSelect() {
                for(ship of data.cgs) {
                    ship.tlName = shipName(ship.name);
                    for(cg of ship.cgs) {
                        cg.tlName = shipName(" " + cg.name).trim();
                    }
                }

                let select = document.getElementById('ships');
                select.innerHTML = "";
                let romanized = !!document.getElementById('romanized').checked;
                data.cgs = data.cgs.sort((a, b) => (romanized) ? a.tlName.localeCompare(b.tlName) : a.name.localeCompare(b.name));
                let index = 0;
                for(ship of data.cgs) {
                    let opt = document.createElement('option');
                    opt.value = JSON.stringify(ship.cgs);
                    if(romanized)
                        opt.innerHTML = ship.tlName;
                    else
                        opt.innerHTML = ship.name;
                    select.appendChild(opt);
                    if(ship.tlName === "Asashio")
                        select.selectedIndex = index;
                    index++;
                }
                console.log(data);
                select.disabled = false;
                select.onchange = makeSecondSelect;
                makeSecondSelect();
            }

            function makeSecondSelect() {
                let select = document.getElementById('cgs');
                select.innerHTML = "";
                let romanized = !!document.getElementById('romanized').checked;
                let e = document.getElementById("ships");
                let cgs = JSON.parse(e.options[e.selectedIndex].value);

                let index = 0;
                for(cg of cgs) {
                    let opt = document.createElement('option');
                    opt.value = JSON.stringify(cg);
                    if(romanized)
                        opt.innerHTML = cg.tlName;
                    else
                        opt.innerHTML = cg.name;
                    select.appendChild(opt);
                    if(cg.tlName === "Kai Ni")
                        select.selectedIndex = index;
                    index++;
                }
                console.log(data);
                select.disabled = false;
                select.onchange = update;
                update();
            }
            // https://github.com/KC3Kai/KC3Kai/blob/master/src/library/modules/Meta.js#L188
            function shipName(jpName, suffixKey = "suffixes", prefixKey = "prefixes"){
                // If full string matched, no combination needed
                if(typeof data.ships[jpName] !== "undefined"){
                    return data.ships[jpName];
                }
                var root = jpName,
                    combinedPrefixes = [],
                    prefixesMap = data.ship_affix[prefixKey] || {},
                    prefixesList = Object.keys(prefixesMap),
                    combinedSuffixes = [],
                    suffixesMap = data.ship_affix[suffixKey] || {},
                    suffixesList = Object.keys(suffixesMap),
                    occurs = [],
                    replaced = false;
                /**********************************************
                // To combine the translations of root name and prefix/suffix,
                // the regular expression will read which one comes first,
                // which mean the prefixes and suffixes in the ship name.
                // and then, the root string will be chopped to remove the affixes,
                // the matched one, added to the combination stack (FILO)
                // removing from the replacement table in order to prevent infinite loop.
                // if there's no match, it'll instantly stop and return the actual value.
                ***********************************************/
                if(prefixesList.length > 0){
                    while( !!(occurs = (new RegExp("^("+prefixesList.join("|")+").+$","i")).exec(root)) ){
                        root = root.replace(new RegExp("^"+occurs[1],"i"), "");
                        if(prefixesMap[occurs[1]].slice(-1) === "$"){
                            combinedSuffixes.unshift(prefixesMap[occurs[1]].slice(0, -1));
                        } else {
                            combinedPrefixes.unshift(prefixesMap[occurs[1]]);
                        }
                        prefixesList.splice(prefixesList.indexOf(occurs[1]), 1);
                        replaced = true;
                    }
                }
                if(suffixesList.length > 0){
                    while( !!(occurs = (new RegExp(".+("+suffixesList.join("|")+")$","i")).exec(root)) ){
                        root = root.replace(new RegExp(occurs[1]+"$","i"), "");
                        if(suffixesMap[occurs[1]].slice(0, 1) === "^"){
                            combinedPrefixes.unshift(suffixesMap[occurs[1]].slice(1));
                        } else {
                            combinedSuffixes.unshift(suffixesMap[occurs[1]]);
                        }
                        suffixesList.splice(suffixesList.indexOf(occurs[1]), 1);
                        replaced = true;
                    }
                }
                if(replaced){
                    // Put combined name into cache
                    return [
                        (combinedPrefixes.length > 0 ? combinedPrefixes.join("") : "") ,
                        (data.ships[root] || root) ,
                        (combinedSuffixes.length > 0 ? combinedSuffixes.join("") : "")
                    ].join("");
                }
                return root;
            }


            let startTween = function() {
                if(bubblesLoaded !== 11) return setTimeout(startTween, 500);
                bubbleLayer.clear();
                for(let i = 0; i < 8; i++) {
                    let bubble = bubbles[Math.floor(Math.random() * bubbles.length)];
                    bubbleLayer.add(createTween(new Konva.Image({
                        image: bubble,
                        width: bubble.width,
                        height: bubble.height
                    })));
                }
            }
            let createTween = function(bubble) {
                let bubbleImg = bubbles[Math.floor(Math.random() * bubbles.length)];
                bubble.setImage(bubbleImg);
                bubble.width(bubbleImg.width);
                bubble.height(bubbleImg.height);
                bubble.opacity(0);
                bubble.setAbsolutePosition({
                    x: Math.floor(Math.random() * 800), 
                    y: Math.floor(Math.random() * 480)
                });
                setTimeout(() => {
                    let tween = new Konva.Tween({
                        node: bubble,
                        duration: 1,
                        opacity: 1,
                        onFinish: () => {
                            let tween2 = new Konva.Tween({
                                node: bubble,
                                duration: 1,
                                opacity: 0,
                                onFinish: () => createTween(bubble)
                            });

                            tween2.play();
                        }
                    });

                    tween.play();
                }, Math.random() * 2000);
                return bubble;
            }
            var stage = new Konva.Stage({
              container: 'ani',
              width: 800,
              height: 480
            });

            var layer = new Konva.Layer();
            var bubbleLayer = new Konva.Layer();
            stage.add(layer);
            stage.add(bubbleLayer);

            get("cgs.json?v=8", "cgs");
            get("https://raw.githubusercontent.com/KC3Kai/kc3-translations/master/data/en/ships.json", "ships");
            get("https://raw.githubusercontent.com/KC3Kai/kc3-translations/master/data/en/ship_affix.json", "ship_affix");

            var bubblesLoaded = 0;
            for(let i = 1; i <= 11; i++) {
                let img = new Image();
                img.onload = function() {
                    bubbles[i-1] = img;
                    bubblesLoaded++;
                }
                img.src = "pics/bubble/" + i + ".png";
            }
            startTween();
        </script>
    </body>
</html>